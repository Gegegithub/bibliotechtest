{% load static %}

<style>
  /* Styles personnalisés pour le menu déroulant Mon Compte */
  .dropdown-menu-center {
    min-width: 200px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border: 1px solid rgba(0,0,0,0.1);
    padding: 8px 0;
  }
  
  .dropdown-menu-center .dropdown-item {
    padding: 10px 20px;
    font-size: 14px;
    transition: all 0.2s ease;
    border-radius: 4px;
    margin: 2px 8px;
  }
  
  .dropdown-menu-center .dropdown-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
  }
  
  .dropdown-menu-center .dropdown-divider {
    margin: 8px 16px;
    border-color: #e9ecef;
  }
  
  /* Animation d'apparition */
  .dropdown-menu-center.show {
    animation: dropdownFadeIn 0.2s ease-out;
  }
  
  @keyframes dropdownFadeIn {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  /* Système de notifications toast */
  .toast-container {
    position: fixed;
    top: 100px;
    right: 20px;
    z-index: 9999;
    max-width: 350px;
  }

  .toast-notification {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border: none;
    margin-bottom: 10px;
    overflow: hidden;
    animation: slideInRight 0.3s ease-out;
  }

  .toast-notification.success {
    border-left: 4px solid #28a745;
  }

  .toast-notification.error {
    border-left: 4px solid #dc3545;
  }

  .toast-notification.warning {
    border-left: 4px solid #ffc107;
  }

  .toast-notification.info {
    border-left: 4px solid #17a2b8;
  }

  .toast-header {
    background: transparent;
    border-bottom: 1px solid #e9ecef;
    padding: 12px 16px 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .toast-title {
    font-weight: 600;
    font-size: 14px;
    color: #333;
  }

  .toast-close {
    background: none;
    border: none;
    font-size: 18px;
    color: #999;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
  }

  .toast-close:hover {
    background: #f8f9fa;
    color: #666;
  }

  .toast-body {
    padding: 8px 16px 12px;
    color: #555;
    font-size: 14px;
    line-height: 1.4;
  }

  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  .toast-notification.hiding {
    animation: slideOutRight 0.3s ease-in forwards;
  }
  /* Styles personnalisés pour le menu déroulant Mon Compte */
  .dropdown-menu-center {
    min-width: 200px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border: 1px solid rgba(0,0,0,0.1);
    padding: 8px 0;
  }
  
  .dropdown-menu-center .dropdown-item {
    padding: 10px 20px;
    font-size: 14px;
    transition: all 0.2s ease;
    border-radius: 4px;
    margin: 2px 8px;
  }
  
  .dropdown-menu-center .dropdown-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
  }
  
  .dropdown-menu-center .dropdown-divider {
    margin: 8px 16px;
    border-color: #e9ecef;
  }
  
  /* Animation d'apparition */
  .dropdown-menu-center.show {
    animation: dropdownFadeIn 0.2s ease-out;
  }
  
  @keyframes dropdownFadeIn {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }
</style>

<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand" href="{% url 'accueil' %}">
      <img src="{% static 'img/Logo nav.webp' %}" alt="Logo CCISCS" height="40">
    </a>

    <!-- Bouton toggler mobile -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
      data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
      aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Contenu de la navbar -->
    <div class="collapse navbar-collapse" id="navbarNav">
      <!-- Liens à gauche -->
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link" href="{% url 'accueil' %}">Accueil</a>
        </li>

        <!-- Menu déroulant bibliothèque -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="bibliothequeDropdown" role="button"
             data-bs-toggle="dropdown" aria-expanded="false">
            Accédez à la bibliothèque
          </a>
          <ul class="dropdown-menu" aria-labelledby="bibliothequeDropdown">
            {% if not request.utilisateur %}
              <li><a class="dropdown-item" href="{% url 'inscription' %}">S'inscrire</a></li>
              <li><a class="dropdown-item" href="{% url 'connexion' %}">Se connecter</a></li>
            {% endif %}
            <li><a class="dropdown-item" href="{% url 'rendez_vous' %}">Prendre rendez-vous</a></li>

            {% if request.utilisateur.est_bibliothecaire %}
              <li><a class="dropdown-item" href="{% url 'gestion_rdv_bibliothecaire' %}">Liste des rendez-vous</a></li>
            {% endif %}

            {% if request.utilisateur.est_personnel %}
              <li><a class="dropdown-item" href="{% url 'gestion_rendezvous' %}">Gestion des rendez-vous (Admin)</a></li>
            {% endif %}
          </ul>
        </li>
      </ul>

      <!-- Barre de recherche à droite -->
      <form class="d-flex align-items-center position-relative" method="get" action="{% url 'recherche' %}">
        <input class="form-control me-2" type="search" placeholder="Rechercher un livre, un auteur ou une catégorie"
               aria-label="Search" id="search-input" name="q" autocomplete="off">

        <div id="suggestions-list"
          class="list-group position-absolute shadow-sm border"
          style="top: 100%; z-index: 1000; width: 100%; background-color: white; display: none;">
        </div>

        <button class="btn btn-outline-secondary" type="submit" title="Rechercher">
          <i class="bi bi-search"></i>
        </button>
      </form>

      <!-- Authentification / Mon Compte -->
      <ul class="navbar-nav ms-3">
        {% if request.utilisateur %}

          <!-- Cloche notifications UNIFIÉE -->
          <li class="nav-item me-2 position-relative">
            {% if request.utilisateur.est_personnel %}
              <a class="nav-link" href="{% url 'gestion_rendezvous' %}" title="Gestion des Rendez-vous" id="rdv-link">
                <i class="bi bi-calendar-check"></i>
                {% if nb_rdv_en_attente|default:0 > 0 %}
                  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="rdv-badge">
                    {{ nb_rdv_en_attente|default:0 }}
                    <span class="visually-hidden">nouvelles demandes de rendez-vous</span>
                  </span>
                {% endif %}
              </a>
            {% elif request.utilisateur.est_bibliothecaire %}
              <a class="nav-link" href="{% url 'notifications' %}" title="Notifications (Bibliothécaire)">
                <i class="bi bi-bell"></i>
                {% if nb_notifications_biblio|default:0 > 0 %}
                  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    {{ nb_notifications_biblio|default:0 }}
                    <span class="visually-hidden">notifications non lues</span>
                  </span>
                {% endif %}
              </a>
            {% elif request.utilisateur.est_admin %}
              <a class="nav-link" href="{% url 'administration_utilisateurs' %}" title="Administration">
                <i class="bi bi-gear"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary">
                  Admin
                </span>
              </a>
            {% else %}
              <a class="nav-link" href="{% url 'mes_notifications' %}" title="Mes Notifications">
                <i class="bi bi-bell"></i>
                {% if nb_notifications_usager|default:0 > 0 %}
                  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    {{ nb_notifications_usager|default:0 }}
                    <span class="visually-hidden">notifications non lues</span>
                  </span>
                {% endif %}
              </a>
            {% endif %}
          </li>

          <!-- Menu Mon Compte -->
          <li class="nav-item dropdown {% if is_mon_compte_active %}active{% endif %}">
            <a class="nav-link dropdown-toggle" href="#" id="monCompteDropdown" role="button"
               data-bs-toggle="dropdown" aria-expanded="false">
              Mon Compte
            </a>
            <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="monCompteDropdown" style="left: 50%; transform: translateX(-50%);">
              <li><a class="dropdown-item" href="{% url 'mon_compte' %}">
                <i class="bi bi-person-circle me-2"></i>Profil
              </a></li>
              <li><a class="dropdown-item" href="{% url 'mes_favoris' %}">
                <i class="bi bi-heart me-2"></i>Mes favoris
              </a></li>
              <li><a class="dropdown-item" href="{% url 'mes_rendezvous' %}">
                <i class="bi bi-calendar-event me-2"></i>Mes rendez-vous
              </a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="{% url 'deconnexion' %}">
                <i class="bi bi-box-arrow-right me-2"></i>Se déconnecter
              </a></li>
            </ul>
          </li>

        {% else %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'connexion' %}?next={{ request.path }}">Connexion</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'inscription' %}">Inscription</a>
          </li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<!-- Conteneur des notifications toast -->
<div id="toast-container" class="toast-container"></div>

<!-- Script pour suggestions dynamiques -->
<script>
  const searchInput = document.getElementById('search-input');
  const suggestionsList = document.getElementById('suggestions-list');

  searchInput.addEventListener('input', function () {
    const query = this.value;
    if (query.length > 1) {
      fetch(`/recherche_suggestions/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          suggestionsList.innerHTML = '';
          if (data.length > 0) {
            data.forEach(item => {
              const suggestionItem = document.createElement('button');
              suggestionItem.type = 'button';
              suggestionItem.classList.add('list-group-item', 'list-group-item-action');
              suggestionItem.textContent = item;
              suggestionItem.addEventListener('click', function () {
                window.location.href = `{% url 'recherche' %}?q=${encodeURIComponent(item)}`;
              });
              suggestionsList.appendChild(suggestionItem);
            });
            suggestionsList.style.display = 'block';
          } else {
            suggestionsList.style.display = 'none';
          }
        });
    } else {
      suggestionsList.innerHTML = '';
      suggestionsList.style.display = 'none';
    }
  });

  document.addEventListener('click', function (event) {
    if (!suggestionsList.contains(event.target) && event.target !== searchInput) {
      suggestionsList.innerHTML = '';
      suggestionsList.style.display = 'none';
    }
  });

  // Système de notifications toast
  function showToast(message, type = 'info', duration = 5000) {
    const toastContainer = document.getElementById('toast-container');
    
    // Créer la notification
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    
    // Déterminer le titre selon le type
    let title = 'Information';
    let icon = 'ℹ️';
    switch(type) {
      case 'success':
        title = 'Succès';
        icon = '✅';
        break;
      case 'error':
        title = 'Erreur';
        icon = '❌';
        break;
      case 'warning':
        title = 'Attention';
        icon = '⚠️';
        break;
    }
    
    toast.innerHTML = `
      <div class="toast-header">
        <span class="toast-title">${icon} ${title}</span>
        <button type="button" class="toast-close" onclick="this.closest('.toast-notification').remove()">×</button>
      </div>
      <div class="toast-body">${message}</div>
    `;
    
    // Ajouter au conteneur
    toastContainer.appendChild(toast);
    
    // Auto-suppression après la durée spécifiée
    setTimeout(() => {
      if (toast.parentNode) {
        toast.classList.add('hiding');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 300);
      }
    }, duration);
  }


  // Fonction globale pour afficher des notifications depuis d'autres scripts
  window.showNotification = showToast;

  // Masquer les notifications après le clic
  document.addEventListener('DOMContentLoaded', function() {
    // Masquer toutes les notifications avec badge
    const notificationLinks = document.querySelectorAll('a .badge');
    notificationLinks.forEach(badge => {
      const link = badge.closest('a');
      if (link) {
        link.addEventListener('click', function() {
          // Animation de disparition
          badge.style.transition = 'opacity 0.3s ease';
          badge.style.opacity = '0';
          
          // Supprimer après l'animation
          setTimeout(() => {
            if (badge.parentNode) {
              badge.remove();
            }
          }, 300);
        });
      }
    });
  });
</script>